#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>

#define MEMO_LIST_SIZE 32

struct message {
	char title[50];
	char body[255];
};

static struct message messages[MEMO_LIST_SIZE];
static char message_list_bitmap[MEMO_LIST_SIZE];

void vuln() {
	asm("pop %rdi; pop %rsi; pop %rdx; ret");
}

void createMemo() {
	struct message tmp;
	
	// Get the title
	write(1, "Title: ", 7);
	scanf("%[^\n]s", tmp.title);
	getchar();
	
	// Get the body
	write(1, "\nBody: ", 7);
	scanf("%[^\n]s", tmp.body);
	getchar();
	
	int id;
	for(id=0; id < MEMO_LIST_SIZE; id++)
		if(!message_list_bitmap[id]) break;
	
	if(id < MEMO_LIST_SIZE) {
		message_list_bitmap[id] = 1;
		memcpy(&(messages[id]), &tmp, sizeof(struct message));
	} else {
		printf("Cannot add new message");
	}
}
void viewMemo() {
	int msg;
	write(1, "Memo ID: ", 9);
	scanf("%d", &msg);
	if(msg >= 0 && msg < MEMO_LIST_SIZE)
		printf("Title: %s\nBody: %s\n", messages[msg].title, messages[msg].body);
	fflush(stdout);
}
void listMemos() {
	int counter, numToShow;
	
	printf("Show X entries (-1 for all)\n");
	scanf("%d", &numToShow);
	
	if(numToShow == -1 || (unsigned)numToShow > MEMO_LIST_SIZE)
		numToShow = MEMO_LIST_SIZE;
	
	write(1, "Titles:\n", 8);
	for(counter = 0; counter < numToShow; counter++) {
		printf(messages[counter].title);
	}
	fflush(stdout);
}
void deleteMemo() {
	int old;
	write(1, "Memo ID to delete: ", 19);
	scanf("%d", &old);
	if(old >= 0 && old < MEMO_LIST_SIZE)
		message_list_bitmap[old] = 0;
}

void usage() {
	printf("Welcome to the simple memo pad\n");
	printf("[1] Create a new memo\n");
	printf("[2] View a memo\n");
	printf("[3] List all memos\n");
	printf("[4] Delete a memo\n");
	printf("[5] Display this screen\n");
	printf("[0] Exit\n");
	fflush(stdout);
}

int main(int argc, char ** argv) {
	char run;
	int option;
	usage();
	
	run = 1;
	while(run) {
		printf("\n> "); fflush(stdout);
		if(scanf("%d", &option) != 1) break;
		
		// Remove '\n'
		getchar();
		
		switch(option)
		{
			case 0: run = 0; break;
			case 5: usage(); break;
			case 1: createMemo(); break;
			case 2: viewMemo(); break;
			case 3: listMemos(); break;
			case 4: deleteMemo(); break;
		}
		option = -1;
	}
	return 0;
}
